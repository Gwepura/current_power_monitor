<!DOCTYPE html>
<html>
    <head> 
        <title>Current Power Monitor</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Bootstrap cdns -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- js of google of chart for PHP Google Charts --> 
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.0/jquery.min.js"></script>
        <script>
            $(document).ready(function () {
                var flow_state = getCookie("flow_state");

                if (flow_state == null) {
                    flow_state = "on";
                    btnToggle(flow_state);
                } else {
                    setToggleState(flow_state);
                }
            });

            // Loads gauges for real time data
            google.charts.load('current', {
              packages: ['gauge']
            }).then(function () {
              var options = {
                minorTicks: 5,
              };

              var chart = new google.visualization.Gauge(document.getElementById('gauges_chart'));

              drawGaugesChart();

              function drawGaugesChart() {
                $.ajax({
                    url: 'get_gauges_data.php',
                    dataType: 'json' 
                }).done(function (jsonData) {
                    if (jsonData.length == 1) {
                        // Display no data
                        $('#no_data').prop('hidden', false);
                    } else {
                        // Use respone from php for data table
                        var data = google.visualization.arrayToDataTable(jsonData);
                        chart.draw(data, options);

                        $('#no_data').prop('hidden', true);
                    }

                    // Draw again in 5 seconds
                    window.setTimeout(drawGaugesChart, 5000);
                });
              };
            });

            // Loads gauges for time vs current data
            google.charts.load('current', {
                packages: ['corechart']
                }).then(function () {
                var options = {
                    title: 'Time vs Current (mA)',
                    legend: { position: ['bottom']},
                    hAxis: {
                        textPosition: 'none',
                        title: 'Time',
                    },
                    vAxis: {
                        title: 'Current'
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('time_current_chart'));

                drawTimeCurrentLineChart();

                function drawTimeCurrentLineChart() {
                    $.ajax({
                        url: 'get_time_current_data.php',
                        dataType: 'json'
                    }).done(function(jsonData) {
                        if (jsonData.length > 1) {
                            var data = google.visualization.arrayToDataTable(jsonData);
                            chart.draw(data, options);
                            $('#time_current_chart').prop('hidden', false);
                        } else {
                            $('#time_current_chart').prop('hidden', true);
                        }
                        

                        // Draw again in 5 seconds
                        window.setTimeout(drawTimeCurrentLineChart, 5000);
                    })
                }
            });
            
            // Loads gauges for time vs voltage data
            google.charts.load('current', {
                packages: ['corechart']
                }).then(function () {
                var options = {
                    title: 'Time vs Voltage (V)',
                    legend: { position: ['bottom']},
                    hAxis: {
                        textPosition: 'none',
                        title: 'Time',
                    },
                    vAxis: {
                        title: 'Voltage'
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('time_voltage_chart'));

                drawTimeVoltageLineChart();

                function drawTimeVoltageLineChart() {
                    $.ajax({
                        url: 'get_time_voltage_data.php',
                        dataType: 'json'
                    }).done(function(jsonData) {
                        if (jsonData.length > 1) {
                            var data = google.visualization.arrayToDataTable(jsonData);
                            chart.draw(data, options);
                            $('#time_voltage_chart').prop('hidden', false);
                        } else {
                            $('#time_voltage_chart').prop('hidden', true);
                        }

                        // Draw again in 5 seconds
                        window.setTimeout(drawTimeVoltageLineChart, 5000);
                    })
                }
            });

            // Loads gauges for time vs voltage data
            google.charts.load('current', {
                packages: ['corechart']
                }).then(function () {
                var options = {
                    title: 'Time vs Power (mW)',
                    legend: { position: ['bottom']},
                    hAxis: {
                        textPosition: 'none',
                        title: 'Time',
                    },
                    vAxis: {
                        title: 'Power'
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('time_power_chart'));

                drawTimePowerLineChart();

                function drawTimePowerLineChart() {
                    $.ajax({
                        url: 'get_time_power_data.php',
                        dataType: 'json'
                    }).done(function(jsonData) {
                        if (jsonData.length > 1) {
                            var data = google.visualization.arrayToDataTable(jsonData);
                            chart.draw(data, options);
                            $('#time_power_chart').prop('hidden', false);
                        } else {
                            $('#time_power_chart').prop('hidden', true);
                        }

                        // Draw again in 5 seconds
                        window.setTimeout(drawTimePowerLineChart, 5000);
                    })
                }
            });
            
            // Loads gauges for time vs flow rate data
            google.charts.load('current', {
                packages: ['corechart']
                }).then(function () {
                var options = {
                    title: 'Time vs Flow Rate',
                    legend: { position: ['bottom']},
                    hAxis: {
                        textPosition: 'none',
                        title: 'Time',
                    },
                    vAxis: {
                        title: 'Flow Rate'
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('time_flow_rate_chart'));

                drawTimeFlowRateLineChart();

                function drawTimeFlowRateLineChart() {
                    $.ajax({
                        url: 'get_time_flow_rate_data.php',
                        dataType: 'json'
                    }).done(function(jsonData) {
                        if (jsonData.length > 1) {
                            var data = google.visualization.arrayToDataTable(jsonData);
                            chart.draw(data, options);
                            $('#time_flow_rate_chart').prop('hidden', false);
                        } else {
                            $('#time_flow_rate_chart').prop('hidden', true);
                        }

                        // Draw again in 5 seconds
                        window.setTimeout(drawTimeFlowRateLineChart, 5000);
                    })
                }
            });

            // Switches between real time data tab and historical data tab
            function changeTab(tab_name) { 
                if(tab_name == "real_time") {
                    document.getElementById("real_time_page").hidden = false;
                    document.getElementById("historical_page").hidden = true;

                    $("#btnHistorical").removeClass("active");
                    $("#btnRealTime").addClass("active");
                } else if (tab_name == "historical") {
                    $("#btnRealTime").removeClass("active");
                    $("#btnHistorical").addClass("active");

                    document.getElementById("real_time_page").hidden = true;
                    document.getElementById("historical_page").hidden = false;
                }
            }

            // Saves flow state
            function btnToggle(state) {
                document.cookie = "flow_state=" + state;
                setToggleState(state);
            }

            // Updates control state buttons
            function setToggleState(state) {
                if(state == "on") {
                    $("#btnOnSwitch").prop('checked', true);
                    $("#btnOnSwitchLabel").removeClass("btn-outline-primary");
                    $("#btnOnSwitchLabel").addClass("btn-primary");
                    
                    $("#btnOffSwitch").prop('checked', false);
                    $("#btnOffSwitchLabel").removeClass("btn-primary");
                } 
                else if(state == "off") {
                    $("#btnOffSwitch").prop('checked', true);
                    $("#btnOffSwitchLabel").removeClass("btn-outline-primary");
                    $("#btnOffSwitchLabel").addClass("btn-primary");
                    
                    $("#btnOnSwitch").prop('checked', false);
                    $("#btnOnSwitchLabel").removeClass("btn-primary");
                }
            }

            // Returns cookie based on name
            function getCookie(name) {
                // Split cookie string and get all individual name=value pairs in an array
                var cookieArr = document.cookie.split(";");
                
                // Loop through the array elements
                for(var i = 0; i < cookieArr.length; i++) {
                    var cookiePair = cookieArr[i].split("=");
                    
                    /* Removing whitespace at the beginning of the cookie name
                    and compare it with the given string */
                    if(name == cookiePair[0].trim()) {
                        // Decode the cookie value and return
                        return decodeURIComponent(cookiePair[1]);
                    }
                }
    
                // Return null if not found
                return null;
            }
        </script>
    </head>
    <body>
        <div class="container-fluid w-75 mx-auto" >
            <h1 class="text-center">Current Power Monitor</h1>
             
            <div class="card text-center">
                <div class="card-header">
                    <div class="float-start">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" aria-current="true" id="btnRealTime" onclick="changeTab('real_time')"> Real Time</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="btnHistorical" onclick="changeTab('historical')"> Historical</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="float-end" id="export_to_csv">
                        <a href="export_to_csv.php" class="btn btn-primary">Export to CSV</a>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#clearDataModal">
                            Clear Data
                        </button>
                    </div>

                    <div class="float-start">
                        <h5>Flow Control Switch</h5>
                        <div class="btn-group" role="group" aria-label="Control Switch">
                            <input type="raido" class="btn-check" name="btnSwitch" id="btnOnSwitch" value="on" onclick="btnToggle('on')" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" id="btnOnSwitchLabel" for="btnOnSwitch">On</label>

                            <input type="raido" class="btn-check" name="btnSwitch" id="btnOffSwitch" value="off" onclick="btnToggle('off')" autocomplete="off">
                            <label class="btn btn-outline-primary" id="btnOffSwitchLabel" for="btnOffSwitch">Off</label>
                        </div>
                    </div>
                
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>

                    <div id="real_time_page" >
                        <h2 class="text-center">Real Time Data</h2>
                        <br>
                        <br>
                        <div id="gauges_chart" style="width:50%;margin-left: auto;margin-right: auto;"></div>
                    </div>
                    <div id="historical_page" hidden="hidden">
                        <h2 class="text-center">Historical Data</h2>
                        <br>
                        <br>
                        <div id="time_current_chart" style="width: 900px; height: 500px; margin-right: auto; margin-left: auto;"></div>
                        <div id="time_voltage_chart" style="width: 900px; height: 500px; margin-right: auto; margin-left: auto;"></div>
                        <div id="time_power_chart" style="width: 900px; height: 500px; margin-right: auto; margin-left: auto;"></div>
                        <div id="time_flow_rate_chart" style="width: 900px; height: 500px; margin-right: auto; margin-left: auto;"></div>
                    </div>

                    <h3 class="text-center" id="no_data" hidden>No data available...</h3>
                </div>
            </div>

            <div class="modal fade" tabindex="-1" id="clearDataModal" aria-labelledby="clearModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="clearModalLabel">Clear Data?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to continue? Changes made will be irreversible.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <a href="delete_data.php" class="btn btn-danger">Clear Data</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
